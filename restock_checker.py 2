# --- AUTO-INSALL DEPENDENCIES ---
import subprocess 
import sys 
for requirements.txt in {"requests","beautifulsoup4","geopy"]:
  subporcess.check_call([sys.executable,"-m", "pip", "install", package]) 

# --- IMPORTS ---
import requests
import time
from bs4 import BeautifulSoup
from geopy.distance import geodesic
from geopy.geocoders import Nominatim
import os

# --- CONFIG ---
DISCORD_WEBHOOK = os.environ.get("DISCORD_WEBHOOK") 
CHECK_INTERVAL = 600  # 10 minutes 
USER_POSTCODE = "DN9"
MAX_DISTANCE_MILES = 25

# --- LOCATION SETUP ---
geolocater = Nominatim(user_agent="pokemon_restocks")
user_location = 
 geolocator.geocode(USER_POSTCODE)
if not user_location:
  raise RuntimeError("Failed to geocode postcode")
USER_COORD = 
 (user_location.latitude,
  user_location.longitude)

# --- STORES & TIERS ---
TIERS = {
  1: {
    "Smyths Doncaster": ("https://www.smythstoys.com/uk/en-gb/search/?text=pokemon", (53.552, -1.128))},
    "The Entertainer Doncaster": ("https://www.thetoyshop.com/search/?text=pokemon", (53.525, -1.120)),
    "Argos Doncaster": ("https://www.argos.co.uk/search/pokemon-trading-cards/", (53.525, -1.130)),
    "WHSmith Doncaster": ("https://www.whsmith.co.uk/seach?query=pokemon", (53.518, -1.121))
  }
  2:{
    "Tesco Doncaster": ("https://www.tesco.com/groceries/en-GB/search?query=pokemon", (53.523, -1.125)),
    "Morrisons Doncaster": ("https://groceries.morrisons.com/search?entry=pokemon", (53.520, -1.127)),
    "ASDA Doncaster": ("https://groceries.asda.com/search/pokemon", (53.519, -1.122)),
    "Sainsbury's Doncaster": ("https://www.sainsburys.co.uk/gol-ui/SearchReuslts/pokemon", (53.518, -1.121))
  }
  3: {
    "Amazon UK": ("https://www.amazon.co.uk/s?k=pokemon+tcg", USER_COORD),
    "eBay UK": ("https://www.ebay.co.uk/sch/i.html?_nkw=pokemon+tcg", USER_COORD),
    "CEX UK": ("https://uk.webuy.com/search/?query=pokemon", USER_COORD),
    "Forbidden Planet": ("https://forbiddenplanet.com/catalogsearch/result/?q=pokemon", USER_COORD),
    "Waterstones": (2https://www.waterstones.com/books/search/term/pokemon", USERCOORD)
                    }
  }
SEALED_KEYWORDS = ["booster", "elite trainer box", "etb", "tin", "collection", "blister", "trading card"]
TOP_PRIORITY_KEYWORDS = ["booster", "elite trainer box", "etb"]
IGNORE_KEYWORDS = ["book", "magazine", "guide", "single"]

seen_items = set()
# --- HELPER FUNCTIONS ---
def is_sealed(name):
  name = name.lower()
  return any(k in name for k in SEALED_KEYWORDS) and not any(i in name for i in IGNORE_KEYWORDS)

  def is_top_priority(name):
    name = name.lower()
    return any(k in name for k in TOP_PRIORITY_KEYWORDS)

  def send_discord(message):
    if not DISCORD_WEBHOOK:
       print("DISCORD_WEBHOOK not set")
      return
    requests.post(DISCORD_WEBHOOKS, json={"content": message})

  def within_distance(store_coord):
    return geodesic(USER_COORD, store_coord).miles <= MAX_DISTANCE_MILES

  def parse_store(store, url, tier, coord):
    if tier != 3 and not within_distance(coord):
      return
    try: 
      r= requests.get(url, timeout=20)
      soup = BeautifulSoup(r.text, "html.parser")
      all_items = [text for text in soup.stripped_strings if "pokemon" in text.lower() and 10 < len(text) <120 and is_sealed(text)]
      new_items = [i fo i in set(all_items) if i not in seen_items]
      if new items:
         top_priority = [i for i in new_items if is_top_priority(i)]
        normal_items = [i for i in new_items if not is_top_priority(i)]
      message = f "{store} {USER_POSTCODE} restock:\n"
      if top_priority:
        message += "Top Priority:\n" + "\n".join(f"-{i} [Tier {tier}]" for i in top_priority[:10}) + "\n"
        for i in top_priority: seen_items.add(i)
          if normal_items:
            message += "Other Sealed TCG Items:\n" + "\n". join(f"- {i}[Tier {tier}]"for i in normal_items[:10]) + "\n"
            for i in normal_items: seen_items.add(i)
          send_discord(message)
    except Exception as e:
      print(f"Error checking {store}: {e}")

      # --- MAIN LOOP ---
      while True:
         try:
        for tier in TIERS:
          for store, (url, coord) in TIERS[tier].items():
            parse_store(store, url, tier, coord)
            time.sleep(CHECK_INTERVAL)
except Exception as e:
print("Main loop error:", e)
time.sleep(60)
      
  
                
